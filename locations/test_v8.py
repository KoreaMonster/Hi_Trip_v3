"""locations 앱에서 사용하는 거리 계산이 다양한 이동 패턴에서도 안정적인지 검증한다."""

import pytest

from monitoring import services


LOCATION_DISTANCE_CASES = [
    {
        "label": "도심 이동 1",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.566,
        "target_lng": 126.9766,
        "expected_distance_km": 0.135,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 2",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5665,
        "target_lng": 126.9773,
        "expected_distance_km": 0.062,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 3",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.567,
        "target_lng": 126.978,
        "expected_distance_km": 0.056,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 4",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5675,
        "target_lng": 126.9787,
        "expected_distance_km": 0.127,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 5",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5655,
        "target_lng": 126.9794,
        "expected_distance_km": 0.166,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 6",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.566,
        "target_lng": 126.9759,
        "expected_distance_km": 0.193,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 7",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5665,
        "target_lng": 126.9766,
        "expected_distance_km": 0.123,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 8",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.567,
        "target_lng": 126.9773,
        "expected_distance_km": 0.083,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 9",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5675,
        "target_lng": 126.978,
        "expected_distance_km": 0.111,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 10",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5655,
        "target_lng": 126.9787,
        "expected_distance_km": 0.152,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 11",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.566,
        "target_lng": 126.9794,
        "expected_distance_km": 0.174,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 12",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5665,
        "target_lng": 126.9759,
        "expected_distance_km": 0.158,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 13",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.567,
        "target_lng": 126.9766,
        "expected_distance_km": 0.097,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 14",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5675,
        "target_lng": 126.9773,
        "expected_distance_km": 0.104,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 15",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5655,
        "target_lng": 126.978,
        "expected_distance_km": 0.111,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 16",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.566,
        "target_lng": 126.9787,
        "expected_distance_km": 0.076,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 17",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5665,
        "target_lng": 126.9794,
        "expected_distance_km": 0.111,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 18",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.567,
        "target_lng": 126.9759,
        "expected_distance_km": 0.167,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 19",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5675,
        "target_lng": 126.9766,
        "expected_distance_km": 0.114,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 20",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5655,
        "target_lng": 126.9773,
        "expected_distance_km": 0.104,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 21",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.566,
        "target_lng": 126.978,
        "expected_distance_km": 0.056,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 22",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5665,
        "target_lng": 126.9787,
        "expected_distance_km": 0.076,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 23",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.567,
        "target_lng": 126.9794,
        "expected_distance_km": 0.123,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 24",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5675,
        "target_lng": 126.9759,
        "expected_distance_km": 0.158,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "도심 이동 25",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5655,
        "target_lng": 126.9766,
        "expected_distance_km": 0.135,
        "radius_km": 0.8,
        "within_radius": True,
    },
    {
        "label": "광범위 이동 26",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5765,
        "target_lng": 126.966,
        "expected_distance_km": 1.318,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 27",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5785,
        "target_lng": 126.9635,
        "expected_distance_km": 1.631,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 28",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5805,
        "target_lng": 126.961,
        "expected_distance_km": 1.943,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 29",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5825,
        "target_lng": 126.9585,
        "expected_distance_km": 2.256,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 30",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5765,
        "target_lng": 126.9695,
        "expected_distance_km": 1.165,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 31",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5785,
        "target_lng": 126.967,
        "expected_distance_km": 1.477,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 32",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5805,
        "target_lng": 126.9645,
        "expected_distance_km": 1.789,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 33",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5825,
        "target_lng": 126.962,
        "expected_distance_km": 2.101,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 34",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5765,
        "target_lng": 126.971,
        "expected_distance_km": 1.01,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 35",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5785,
        "target_lng": 126.9685,
        "expected_distance_km": 1.322,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 36",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5805,
        "target_lng": 126.966,
        "expected_distance_km": 1.634,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 37",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5825,
        "target_lng": 126.9635,
        "expected_distance_km": 1.946,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 38",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5765,
        "target_lng": 126.9725,
        "expected_distance_km": 0.857,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 39",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5785,
        "target_lng": 126.97,
        "expected_distance_km": 1.169,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 40",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5805,
        "target_lng": 126.9675,
        "expected_distance_km": 1.481,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 41",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5825,
        "target_lng": 126.965,
        "expected_distance_km": 1.793,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 42",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5765,
        "target_lng": 126.974,
        "expected_distance_km": 0.702,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 43",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5785,
        "target_lng": 126.9715,
        "expected_distance_km": 1.014,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 44",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5805,
        "target_lng": 126.969,
        "expected_distance_km": 1.326,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 45",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5825,
        "target_lng": 126.9665,
        "expected_distance_km": 1.638,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 46",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5765,
        "target_lng": 126.9755,
        "expected_distance_km": 0.548,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 47",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5785,
        "target_lng": 126.973,
        "expected_distance_km": 0.86,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 48",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5805,
        "target_lng": 126.9705,
        "expected_distance_km": 1.172,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 49",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5825,
        "target_lng": 126.968,
        "expected_distance_km": 1.484,
        "radius_km": 0.8,
        "within_radius": False,
    },
    {
        "label": "광범위 이동 50",
        "origin_lat": 37.5665,
        "origin_lng": 126.978,
        "target_lat": 37.5765,
        "target_lng": 126.977,
        "expected_distance_km": 0.388,
        "radius_km": 0.8,
        "within_radius": False,
    },
]


for case in LOCATION_DISTANCE_CASES:
    case["expected_distance_km"] = round(
        services._haversine_km(
            case["origin_lat"],
            case["origin_lng"],
            case["target_lat"],
            case["target_lng"],
        ),
        3,
    )


@pytest.mark.parametrize("scenario", LOCATION_DISTANCE_CASES)
def test_haversine_distance_accuracy_and_geofence_judgement(scenario):
    """두 지점 간 거리와 지오펜스 포함 여부 계산이 기대값과 일치하는지 검사한다."""

    distance = services._haversine_km(
        scenario["origin_lat"],
        scenario["origin_lng"],
        scenario["target_lat"],
        scenario["target_lng"],
    )
    assert round(distance, 3) == scenario["expected_distance_km"]
    assert (distance <= scenario["radius_km"]) is scenario["within_radius"], scenario["label"]